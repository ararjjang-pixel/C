<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>íƒ„ì†Œë°œìêµ­ ì¤„ì´ë©´ ë°›ëŠ” í¬ì¸íŠ¸</title>
  <style>
    /* ê¹”ë”í•˜ë©´ì„œ ì•½ê°„ ë³‘ë§› í¬ì¸íŠ¸ */
    :root{
      --sidebar:#0f1724;
      --bg:#f5f8fb;
      --card:#ffffff;
      --accent:#ff4d4d;
      --muted:#6b7280;
      --glass: rgba(255,255,255,0.7);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#f7fbff 0%, #f5f8fb 100%);}
    .app{display:flex;height:100vh;min-height:600px;overflow:hidden}
    /* LEFT SIDEBAR */
    .sidebar{width:280px;background:var(--sidebar);color:#fff;padding:20px;display:flex;flex-direction:column;gap:14px}
    .logo{font-weight:800;font-size:18px;text-align:center;padding:6px 10px;border-radius:10px;background:linear-gradient(90deg,#0b1220,#101827)}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .nav button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#e6eef8;padding:12px;border-radius:10px;text-align:left;cursor:pointer;font-weight:700}
    .nav button.active{background:linear-gradient(90deg,#ff9a9a,#ff4d4d);color:#fff;box-shadow:0 8px 18px rgba(255,77,77,0.18)}
    .sidebar-footer{margin-top:auto;font-size:13px;color:rgba(255,255,255,0.6);text-align:center}
    /* MAIN */
    .main{flex:1;overflow:auto;padding:28px}
    .wrap{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    header h1{margin:0;font-size:20px;color:#111827}
    .btn{background:linear-gradient(90deg,#ffd27a,#ffb347);border:none;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
    /* Grid */
    .home-grid{display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:start}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 24px rgba(15,23,36,0.06);border:1px solid rgba(15,23,36,0.03)}
    /* big meter */
    .big-circle-wrap{display:flex;flex-direction:column;align-items:center;gap:14px;height:560px;padding-top:12px}
    .target-label{font-weight:800;color:#374151}
    .meter{position:relative;width:380px;height:380px}
    canvas#meter{width:100%;height:100%;display:block}
    .center-info{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center}
    .center-info .kg{font-weight:900;font-size:28px;color:#1f2937}
    .center-info .desc{font-size:12px;color:var(--muted)}
    /* penguin */
    .penguin{position:absolute;left:50%;transform:translateX(-50%);top:-14px;width:120px;height:120px;transition:transform .18s ease}
    .penguin svg{width:100%;height:100%;display:block}
    .penguin .angry{display:none}
    .penguin.angry .calm{display:none}
    .penguin.angry .angry{display:block}
    /* right column */
    .control{display:flex;flex-direction:column;gap:12px}
    .stat{font-weight:900;font-size:18px;color:#111827}
    input[type=range]{width:100%}
    input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf3}
    .small-muted{font-size:13px;color:var(--muted)}
    .points-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .point-card{padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fff8f0);border:1px dashed #f3e6e6}
    /* sections */
    .section{min-height:calc(100vh - 140px);padding-top:8px}
    /* charts and tables */
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .chart{width:100%;height:220px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:8px;padding:6px;border:1px solid #eef2f7}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #f2f6fb;text-align:center;color:#374151}
    /* responsive */
    @media(max-width:980px){
      .app{flex-direction:column}
      .sidebar{width:100%;display:flex;flex-direction:row;gap:8px;overflow:auto;padding:12px}
      .home-grid{grid-template-columns:1fr;gap:12px}
      .meter{width:320px;height:320px}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="logo">ğŸ§ íƒ„ì†Œë°œìêµ­ ì¤„ì´ë©´ ë°›ëŠ” í¬ì¸íŠ¸</div>
      <nav class="nav" role="navigation" aria-label="ë©”ë‰´">
        <button class="nav-btn active" data-target="home">í™ˆ</button>
        <button class="nav-btn" data-target="points">í¬ì¸íŠ¸ ì‚¬ìš©</button>
        <button class="nav-btn" data-target="stats">í†µê³„</button>
        <button class="nav-btn" data-target="sponsor">í›„ì›</button>
      </nav>
      <div class="sidebar-footer">ì‹¤ì‹œê°„ ì´ë™ ì¶”ì  â€¢ ì‹œë®¬ë ˆì´í„° í¬í•¨</div>
    </aside>

    <main class="main">
      <div class="wrap">
        <header>
          <h1>íƒ„ì†Œë°œìêµ­ ì¤„ì´ë©´ ë°›ëŠ” í¬ì¸íŠ¸</h1>
          <div style="display:flex;gap:10px;align-items:center">
            <button class="btn" id="toggleTrack">ìœ„ì¹˜ì¶”ì  ì‹œì‘</button>
            <button class="btn" id="resetBtn" style="background:linear-gradient(90deg,#ffdddd,#ffbdbd)">ë°ì´í„° ë¦¬ì…‹</button>
          </div>
        </header>

        <!-- HOME -->
        <section id="home" class="section">
          <div class="home-grid">
            <div class="card big-circle-wrap" aria-live="polite">
              <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
                <div class="target-label">ì˜¤ëŠ˜ ëª©í‘œ: <strong id="targetKg">2.0</strong> kgCOâ‚‚</div>
                <div class="small-muted">í¬ì¸íŠ¸: <strong id="pointsLarge">0 P</strong></div>
              </div>

              <div class="meter" role="img" aria-label="íƒ„ì†Œ ë¯¸í„°">
                <canvas id="meter" width="760" height="760"></canvas>

                <!-- penguin -->
                <div class="penguin" id="penguin">
                  <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <g class="calm">
                      <ellipse cx="60" cy="70" rx="36" ry="32" fill="#2b2b2b" />
                      <ellipse cx="60" cy="58" rx="26" ry="22" fill="#fff" />
                      <circle cx="50" cy="55" r="4" fill="#000" />
                      <circle cx="70" cy="55" r="4" fill="#000" />
                      <path d="M54 70 q6 8 12 0" stroke="#000" stroke-width="2" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="angry">
                      <ellipse cx="60" cy="70" rx="36" ry="32" fill="#2b2b2b" />
                      <ellipse cx="60" cy="58" rx="26" ry="22" fill="#fff" />
                      <path d="M44 53 q8 -6 12 0" stroke="#000" stroke-width="3" fill="none" stroke-linecap="round"/>
                      <path d="M76 53 q-8 -6 -12 0" stroke="#000" stroke-width="3" fill="none" stroke-linecap="round"/>
                      <path d="M54 74 q6 -2 12 0" stroke="#000" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                  </svg>
                </div>

                <div class="center-info" aria-hidden="true">
                  <div class="kg" id="currentKg">0.00 kg</div>
                  <div class="desc small-muted" id="detailDesc">ì´ë™ìœ¼ë¡œ ê³„ì‚°ëœ ì¶”ì •ê°’</div>
                </div>
              </div>

              <div style="width:100%;display:flex;gap:12px;align-items:flex-end;margin-top:6px">
                <div style="flex:1">
                  <div style="display:flex;gap:10px;align-items:center">
                    <div style="flex:1">
                      <label class="small-muted">ëª©í‘œ(kgCOâ‚‚)</label>
                      <input id="targetInput" type="number" step="0.1" min="0" value="2.0" />
                    </div>
                    <div style="width:120px">
                      <label class="small-muted">ê°ì†Œ ê¸°ì¤€(%)</label>
                      <input id="threshold" type="number" min="1" max="100" value="10" />
                    </div>
                  </div>

                  <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                    <button class="btn" id="claimBtn">í¬ì¸íŠ¸ ë°˜ì˜</button>
                    <div style="flex:1" class="small-muted">ì–´ì œì™€ ë¹„êµí•˜ì—¬ ì„¤ì •í•œ ë¹„ìœ¨ ì´ìƒ ì¤„ì´ë©´ í¬ì¸íŠ¸ ì§€ê¸‰</div>
                  </div>

                  <div style="margin-top:10px" class="small-muted">
                    <div>ì–´ì œ: <strong id="yesterdayKg">--</strong> kg Â· ì´ë™ ê±°ë¦¬(ì˜¤ëŠ˜): <strong id="todayKm">0.00</strong> km</div>
                  </div>
                </div>

                <div style="width:240px" class="card" aria-hidden="true">
                  <div style="font-weight:900">ì‹œë®¬ë ˆì´í„° (í…ŒìŠ¤íŠ¸ìš©)</div>
                  <div style="margin-top:8px"><input type="range" id="simRange" min="0" max="3000" value="0" /></div>
                  <div style="font-size:12px;color:var(--muted);margin-top:6px">ìŠ¬ë¼ì´ë”ëŠ” ê·¸ë¨ ë‹¨ìœ„. ì‹¤ì œ ì¶”ì ì„ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ ìœ„ì¹˜ì¶”ì ì„ ì¼œì„¸ìš”.</div>
                </div>
              </div>
            </div>

            <aside class="card control">
              <div style="display:flex;flex-direction:column;gap:10px">
                <div>
                  <div class="stat">í¬ì¸íŠ¸</div>
                  <div style="font-size:22px;font-weight:900;color:#111827" id="pointsDisplay">0 P</div>
                </div>

                <div>
                  <div class="stat">ì¶”ì  ìƒíƒœ</div>
                  <div class="small-muted" id="trackStatus">ë¹„í™œì„±</div>
                </div>

                <div>
                  <div class="stat">í¬ì¸íŠ¸ ì‚¬ìš© ì˜ˆì‹œ</div>
                  <div class="points-list">
                    <div class="point-card">ì»¤í”¼ ì¿ í° 500P</div>
                    <div class="point-card">ì§€ì—­ ë‚˜ë¬´ì‹¬ê¸° ì°¸ì—¬ê¶Œ 1000P</div>
                    <div class="point-card">íƒ„ì†Œì¤‘ë¦½ êµ¿ì¦ˆ 2000P</div>
                  </div>
                </div>
              </div>
            </aside>
          </div>
        </section>

        <!-- POINTS -->
        <section id="points" class="section" style="display:none">
          <div class="card">
            <h2 style="margin:0 0 8px 0">í¬ì¸íŠ¸ ì‚¬ìš©</h2>
            <p class="small-muted">í˜„ì¬ í¬ì¸íŠ¸: <strong id="pointsNow">0</strong> P</p>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn redeem" data-cost="500">ì»¤í”¼ ì¿ í° (500P)</button>
              <button class="btn redeem" data-cost="1000">ë‚˜ë¬´ì‹¬ê¸° (1000P)</button>
              <button class="btn redeem" data-cost="2000">êµ¿ì¦ˆ (2000P)</button>
            </div>
            <div id="redeemMsg" style="margin-top:12px;color:var(--muted)"></div>
          </div>
        </section>

        <!-- STATS -->
        <section id="stats" class="section" style="display:none">
          <div class="card">
            <h2 style="margin:0 0 12px 0">í†µê³„</h2>
            <div class="charts-grid">
              <div>
                <div class="small-muted">ì¼ì£¼ì¼ê°„ íƒ„ì†Œ(kg)</div>
                <canvas id="weekChart" class="chart"></canvas>
                <table id="weekTable"><thead><tr><th>ë‚ ì§œ</th><th>kgCOâ‚‚</th></tr></thead><tbody></tbody></table>
              </div>
              <div>
                <div class="small-muted">í•œë‹¬ê°„ íƒ„ì†Œ(kg)</div>
                <canvas id="monthChart" class="chart"></canvas>
                <table id="monthTable"><thead><tr><th>ë‚ ì§œ</th><th>kgCOâ‚‚</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
        </section>

        <!-- SPONSOR -->
        <section id="sponsor" class="section" style="display:none">
          <div class="card">
            <h2 style="margin:0 0 8px 0">í›„ì›</h2>
            <p class="small-muted">ê°ì‚¬í•©ë‹ˆë‹¤! í›„ì› ì‹œ í•˜íŠ¸ ì´í™íŠ¸ê°€ í„°ì§‘ë‹ˆë‹¤.</p>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="sponsor10">â‚©1,000 (ë°ëª¨)</button>
              <button class="btn" id="sponsor50">â‚©5,000 (ë°ëª¨)</button>
              <button class="btn" id="sponsor100">â‚©10,000 (ë°ëª¨)</button>
            </div>
            <div id="sponsorMsg" style="margin-top:12px;color:var(--muted)"></div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    /************************************************************************
     * ë°ì´í„° êµ¬ì¡°: localStorageì— ë³´ê´€
     * db = {
     *   daily: { 'YYYY-MM-DD': kgCO2, ... },
     *   points: number,
     *   track: { lastPos: {lat,lon,t}, totalKmToday: number }
     * }
     ************************************************************************/
    const DB_KEY = 'carbon_auto_demo_v2';
    let db = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
    if(!db.daily) db.daily = {};
    if(!db.points) db.points = 0;
    if(!db.track) db.track = {};
    const today = (d=>d.toISOString().slice(0,10))(new Date());
    const yesterday = (d=>d.toISOString().slice(0,10))(new Date(Date.now()-86400000));
    if(db.daily[today] === undefined) db.daily[today] = 0;
    if(db.daily[yesterday] === undefined) db.daily[yesterday] = 0;

    function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    // UI ì—˜ë¦¬ë¨¼íŠ¸
    const navBtns = document.querySelectorAll('.nav-btn');
    const sections = {
      home: document.getElementById('home'),
      points: document.getElementById('points'),
      stats: document.getElementById('stats'),
      sponsor: document.getElementById('sponsor')
    };
    navBtns.forEach(b=>b.addEventListener('click', ()=>{
      navBtns.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      Object.values(sections).forEach(s=>s.style.display='none');
      sections[b.dataset.target].style.display = 'block';
      if(b.dataset.target === 'stats'){ setTimeout(()=>{ renderWeek(); renderMonth(); },150); }
    }));

    // elements
    const meterCanvas = document.getElementById('meter');
    const ctx = meterCanvas.getContext('2d');
    const penguin = document.getElementById('penguin');
    const currentKgEl = document.getElementById('currentKg');
    const targetInput = document.getElementById('targetInput');
    const targetKgEl = document.getElementById('targetKg');
    const simRange = document.getElementById('simRange');
    const claimBtn = document.getElementById('claimBtn');
    const thresholdInput = document.getElementById('threshold');
    const pointsDisplay = document.getElementById('pointsDisplay');
    const pointsNowEl = document.getElementById('pointsNow');
    const pointsLarge = document.getElementById('pointsLarge');
    const todayKmEl = document.getElementById('todayKm');
    const yesterdayKgEl = document.getElementById('yesterdayKg');
    const trackStatusEl = document.getElementById('trackStatus');
    const toggleTrackBtn = document.getElementById('toggleTrack');
    const resetBtn = document.getElementById('resetBtn');

    // ì‹œë®¬ë ˆì´í„°
    simRange.addEventListener('input', ()=>{
      const g = parseInt(simRange.value,10);
      // ìŠ¬ë¼ì´ë”ëŠ” grams -> kg
      db.daily[today] = +(g/1000).toFixed(3);
      saveDB(); renderAll();
    });

    // í¬ì¸íŠ¸ ì‚¬ìš©
    document.querySelectorAll('.redeem').forEach(b=>{
      b.addEventListener('click', ()=>{
        const cost = parseInt(b.dataset.cost,10);
        if(db.points >= cost){ db.points -= cost; document.getElementById('redeemMsg').textContent = `ì‚¬ìš© ì™„ë£Œ: ${cost}P ì†Œë¹„`; }
        else { document.getElementById('redeemMsg').textContent = 'í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.'; }
        saveDB(); renderAll();
      });
    });

    // í›„ì›
    ['sponsor10','sponsor50','sponsor100'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener('click', ()=>{ document.getElementById('sponsorMsg').textContent = 'ê°ì‚¬í•©ë‹ˆë‹¤! í•˜íŠ¸ í­ë°œ!'; heartBomb(); });
    });

    // í•˜íŠ¸ ì´í™íŠ¸
    function heartBomb(){
      for(let i=0;i<24;i++){
        const h = document.createElement('div'); h.textContent='ğŸ’–';
        h.style.position='fixed'; h.style.left=(10+Math.random()*80)+'%'; h.style.top=(10+Math.random()*70)+'%';
        h.style.fontSize=(12+Math.random()*36)+'px'; h.style.opacity='0.95'; h.style.pointerEvents='none';
        document.body.appendChild(h);
        setTimeout(()=>{ h.style.transition='all 900ms ease'; h.style.transform='translateY(-40px) rotate('+ (Math.random()*40-20) +'deg)'; h.style.opacity='0'; },10);
        setTimeout(()=>h.remove(),1100);
      }
    }

    // í¬ì¸íŠ¸ ì§€ê¸‰ ë¡œì§ (ì–´ì œ ëŒ€ë¹„ ì„¤ì • ë¹„ìœ¨ ì´ìƒ ì¤„ì˜€ì„ ë•Œ)
    claimBtn.addEventListener('click', ()=>{
      const cur = db.daily[today] || 0;
      const prev = db.daily[yesterday] || 0;
      const thresh = (parseFloat(thresholdInput.value)||10) / 100;
      if(prev <= 0){ alert('ì–´ì œ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ 0kgì…ë‹ˆë‹¤. ë¹„êµ ë¶ˆê°€.'); return; }
      const reduction = (prev - cur) / prev;
      if(reduction >= thresh){
        // í¬ì¸íŠ¸ í™˜ì‚°: (ê°ì†Œí•œ kg) * 100 (demo) => ì •ìˆ˜
        const pointsGain = Math.max(1, Math.round((prev - cur) * 100));
        db.points += pointsGain;
        alert(`ì„±ê³µ! ${pointsGain}P íšë“í–ˆìŠµë‹ˆë‹¤.`);
      } else {
        alert('ì¤„ì¸ ë¹„ìœ¨ì´ ê¸°ì¤€ì— ë¯¸ì¹˜ì§€ ëª»í•©ë‹ˆë‹¤.');
      }
      saveDB(); renderAll();
    });

    // ë¦¬ì…‹
    resetBtn.addEventListener('click', ()=>{
      if(confirm('ë°ëª¨ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')){
        db = { daily: {}, points: 0, track: {} };
        const d = new Date(); db.daily[d.toISOString().slice(0,10)] = 0;
        saveDB(); renderAll();
      }
    });

    /**********************
     * ì´ë™ ì¶”ì  ë¡œì§ (Geolocation)
     * - successive ìœ„ì¹˜ì—ì„œ ê±°ë¦¬ ê³„ì‚° (Haversine)
     * - ì†ë„ë¡œ ì´ë™ìˆ˜ë‹¨ ì¶”ì •
     * - ì´ë™ìˆ˜ë‹¨ë³„ kgCO2/km ê³„ìˆ˜ ì ìš©
     **********************/
    let watchId = null;
    let tracking = false;

    // ë°°ì¶œê³„ìˆ˜(kg CO2 per km) â€” ì¶”ì •ì¹˜(ë°ëª¨ìš©)
    const EMISSION_FACTORS = {
      car: 0.210,     // ìŠ¹ìš©ì°¨ í‰ê·  0.21 kgCO2/km
      bus: 0.089,     // ë²„ìŠ¤(ìŠ¹ê°ë¶„ì‚°) ì¶”ì •
      motorcycle: 0.12,
      train: 0.045,
      bicycle: 0.0,
      walk: 0.0,
      electric_car: 0.120 // ì „ê¸°ì°¨ ì¶”ì •ê°’(ì „ë ¥ mix)
    };

    // ì†ë„(km/h)ë¡œ êµí†µìˆ˜ë‹¨ ì¶”ì •
    function guessTransport(speedKmh){
      if(speedKmh < 6) return 'walk';
      if(speedKmh < 20) return 'bicycle'; // ì „ë™í‚¥ë³´ë“œ/ìì „ê±° í¬í•¨
      if(speedKmh < 40) return 'bus';
      if(speedKmh < 120) return 'car';
      return 'train';
    }

    // Haversine ê±°ë¦¬ ê³„ì‚° (km)
    function haversine(lat1, lon1, lat2, lon2){
      const R = 6371.0; // km
      const toRad = (v)=> v * Math.PI/180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function startTracking(){
      if(!navigator.geolocation){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      if(tracking) return;
      watchId = navigator.geolocation.watchPosition(positionHandler, geoError, { enableHighAccuracy:true, maximumAge:5000, timeout:10000 });
      tracking = true;
      toggleTrackBtn.textContent = 'ìœ„ì¹˜ì¶”ì  ì¤‘ì§€';
      trackStatusEl.textContent = 'ì¶”ì ì¤‘';
    }

    function stopTracking(){
      if(watchId !== null) navigator.geolocation.clearWatch(watchId);
      watchId = null; tracking = false;
      toggleTrackBtn.textContent = 'ìœ„ì¹˜ì¶”ì  ì‹œì‘';
      trackStatusEl.textContent = 'ë¹„í™œì„±';
    }

    toggleTrackBtn.addEventListener('click', ()=>{
      if(tracking) stopTracking(); else startTracking();
    });

    function geoError(err){
      console.warn('Geolocation error', err);
      alert('ìœ„ì¹˜ ê¶Œí•œì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
      stopTracking();
    }

    function positionHandler(pos){
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const t = pos.timestamp;
      // ì´ì „ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ê±°ë¦¬ ê³„ì‚°
      if(db.track.lastPos && db.track.lastPos.lat !== undefined){
        const prev = db.track.lastPos;
        // ì‹œê°„ diff in hours
        const dt = Math.max(1, (t - prev.t)) / 3600000; // hours, avoid 0
        const dkm = haversine(prev.lat, prev.lon, lat, lon); // km
        const speedKmh = dkm / dt;
        const mode = guessTransport(speedKmh);
        const factor = EMISSION_FACTORS[mode] !== undefined ? EMISSION_FACTORS[mode] : EMISSION_FACTORS.car;
        const kgCO2 = dkm * factor;
        // ëˆ„ì  ì˜¤ëŠ˜ ê±°ë¦¬, ë°°ì¶œ
        db.track.totalKmToday = (db.track.totalKmToday || 0) + dkm;
        db.daily[today] = +( (db.daily[today] || 0) + kgCO2 ).toFixed(4);
        // update lastPos
        db.track.lastPos = { lat, lon, t };
        saveDB();
        renderAll();
      } else {
        db.track.lastPos = { lat, lon, t };
        if(db.track.totalKmToday === undefined) db.track.totalKmToday = 0;
        saveDB();
      }
    }

    /**********************
     * ìº”ë²„ìŠ¤ ë¯¸í„° ë Œë”ë§
     **********************/
    function renderMeter(){
      const dpr = window.devicePixelRatio || 1;
      const w = meterCanvas.clientWidth;
      const h = meterCanvas.clientHeight;
      meterCanvas.width = w * dpr;
      meterCanvas.height = h * dpr;
      ctx.clearRect(0,0,meterCanvas.width,meterCanvas.height);
      ctx.scale(dpr,dpr);

      const cx = w/2, cy = h/2, r = Math.min(w,h)/2 - 24;
      // base ring
      ctx.lineWidth = 22; ctx.lineCap='round';
      ctx.beginPath(); ctx.strokeStyle = '#eee'; ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();

      // percentage: current / target
      const cur = db.daily[today] || 0;
      const target = parseFloat(targetInput.value) || 0.001;
      const pct = Math.min(1, cur / Math.max(0.0001, target));
      const endAngle = -Math.PI/2 + pct * Math.PI*2;

      // color gradient red increasing
      const red = Math.round(255 * pct);
      const green = Math.round(120 * (1 - pct));
      ctx.beginPath(); ctx.strokeStyle = `rgb(${red},${green},40)`; ctx.arc(cx,cy,r,-Math.PI/2,endAngle); ctx.stroke();

      // center text
      ctx.font = '700 28px system-ui, sans-serif'; ctx.fillStyle = '#111827'; ctx.textAlign='center';
      ctx.fillText((cur).toFixed(2) + ' kg', cx, cy);
      ctx.font = '12px system-ui, sans-serif'; ctx.fillStyle = '#6b7280'; ctx.fillText('ì˜¤ëŠ˜ ì¶”ì • ë°°ì¶œëŸ‰', cx, cy + 22);

      // penguin mood
      if(pct < 0.4){
        penguin.classList.remove('angry');
        penguin.style.transform = 'translateX(-50%) translateY(0)';
      } else if(pct < 0.75){
        penguin.classList.add('angry');
        penguin.style.transform = 'translateX(-50%) translateY(-6px) scale(1.02)';
      } else {
        penguin.classList.add('angry');
        penguin.style.transform = 'translateX(-50%) translateY(-14px) scale(1.08)';
      }
    }

    /**********************
     * í†µê³„ ë Œë”ë§ (ê°„ë‹¨ ìº”ë²„ìŠ¤ ì°¨íŠ¸)
     **********************/
    function getLastNDates(n){
      const arr=[];
      for(let i=0;i<n;i++){
        const d = new Date(Date.now() - (n-1-i)*86400000);
        arr.push(d.toISOString().slice(0,10));
      }
      return arr;
    }

    function renderWeek(){
      const dates = getLastNDates(7);
      const data = dates.map(d => db.daily[d] || 0);
      // table
      const tbody = document.querySelector('#weekTable tbody'); tbody.innerHTML = '';
      dates.forEach((d,i)=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${d}</td><td>${data[i].toFixed(2)}</td>`; tbody.appendChild(tr); });

      // chart
      const c = document.getElementById('weekChart'); const g = c.getContext('2d');
      c.width = c.clientWidth * 2; c.height = c.clientHeight * 2; g.clearRect(0,0,c.width,c.height);
      const pad = 36 * 2; const max = Math.max(0.5, ...data) * 2;
      const w = (c.width - pad*2) / data.length;
      data.forEach((v,i)=>{
        const h = Math.round((v/max) * (c.height - pad*2));
        g.fillStyle = 'rgba(0,0,0,0.6)'; g.fillRect(pad + i*w + 8, c.height - pad - h, w - 16, h);
      });
    }

    function renderMonth(){
      const dates = getLastNDates(30);
      const data = dates.map(d => db.daily[d] || 0);
      // table
      const tbody = document.querySelector('#monthTable tbody'); tbody.innerHTML = '';
      dates.forEach((d,i)=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${d}</td><td>${data[i].toFixed(2)}</td>`; tbody.appendChild(tr); });

      // chart
      const c = document.getElementById('monthChart'); const g = c.getContext('2d');
      c.width = c.clientWidth * 2; c.height = c.clientHeight * 2; g.clearRect(0,0,c.width,c.height);
      const pad = 36 * 2; const max = Math.max(0.5, ...data) * 2;
      const w = (c.width - pad*2) / data.length;
      data.forEach((v,i)=>{
        const h = Math.round((v/max) * (c.height - pad*2));
        g.fillStyle = 'rgba(15,23,36,0.5)'; g.fillRect(pad + i*w + 2, c.height - pad - h, Math.max(1, w - 4), h);
      });
    }

    /**********************
     * ì´ˆê¸° ë°ëª¨ ë°ì´í„° ì±„ìš°ê¸° (ì—†ëŠ” ë‚ ì§œëŠ” ëœë¤)
     **********************/
    (function fillDemo(){
      const dates = getLastNDates(30);
      let changed = false;
      dates.forEach(d=>{
        if(db.daily[d] === undefined){ db.daily[d] = +(Math.random()*2.2).toFixed(3); changed = true; }
      });
      if(changed) saveDB();
    })();

    /**********************
     * ë Œë” ì „ì²´
     **********************/
    function renderAll(){
      // UI texts
      document.getElementById('pointsNow').textContent = db.points;
      document.getElementById('pointsLarge').textContent = db.points + ' P';
      pointsDisplay.textContent = db.points + ' P';
      targetKgEl.textContent = parseFloat(targetInput.value || 0).toFixed(1);
      todayKmEl.textContent = (db.track.totalKmToday || 0).toFixed(2);
      yesterdayKgEl.textContent = (db.daily[yesterday] || 0).toFixed(2);
      trackStatusEl.textContent = tracking ? 'ì¶”ì ì¤‘' : 'ë¹„í™œì„±';

      // meter
      renderMeter();
      // stats
      renderWeek();
      renderMonth();
    }

    // í†µê³„ íƒ­ì—ì„œ ê·¸ë¦¬ê¸° ì§€ì—°(ë²„ê·¸ ë°©ì§€)
    document.querySelector('button[data-target=stats]').addEventListener('click', ()=>{ setTimeout(()=>{ renderWeek(); renderMonth(); }, 200); });

    // ìœ„ì¹˜ ì¶”ì  ìƒíƒœ ë³µêµ¬(ë‹¨, ë¸Œë¼ìš°ì €ì— ë”°ë¼ ìë™ ì¬ì‹œì‘ ì•ˆë¨)
    renderAll();

    // ê°„ë‹¨í•œ ì‹œì—°ìš©: ìœ„ì¹˜ ì¶”ì  ë¶ˆê°€ëŠ¥í•  ë•Œë„ ìŠ¬ë¼ì´ë”ë¡œ ì¡°ì‘ ê°€ëŠ¥
    // (ì´ë¯¸ simRangeê°€ input listenerë¡œ ì²˜ë¦¬)

    // í˜ì´ì§€ ë– ë‚  ë•Œ ì €ì¥
    window.addEventListener('beforeunload', saveDB);
  </script>
</body>
</html>
